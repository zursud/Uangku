<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laporan Keuangan Harian, Bulanan dan Tahunan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4CAF50;
            --primary-light: #81C784;
            --primary-dark: #388E3C;
            --secondary: #2196F3;
            --secondary-light: #64B5F6;
            --danger: #F44336;
            --warning: #FF9800;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --white: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        /* Header Styles */
        .app-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .app-title {
            color: var(--primary-dark);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }
        
        .tagline {
            color: var(--gray);
            font-size: 14px;
            font-style: italic;
            margin-bottom: 20px;
        }
        
        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            border-top: 4px solid;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-income {
            border-color: var(--primary);
        }
        
        .card-expense {
            border-color: var(--danger);
        }
        
        .card-balance {
            border-color: var(--secondary);
        }
        
        .card-title {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .card-income .card-value {
            color: var(--primary-dark);
        }
        
        .card-expense .card-value {
            color: var(--danger);
        }
        
        .card-balance .card-value {
            color: var(--secondary);
        }
        
        /* Form Styles */
        .form-container {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }
        
        .form-title {
            text-align: center;
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s ease;
            background-color: var(--white);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        /* Button Styles */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--white);
        }
        
        .btn-secondary:hover {
            background-color: #1976D2;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }
        
        .btn-danger:hover {
            background-color: #D32F2F;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--white);
        }
        
        .btn-warning:hover {
            background-color: #F57C00;
        }
        
        /* Table Styles */
        .data-section {
            margin-top: 30px;
        }
        
        .section-title {
            text-align: center;
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .search-filter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            position: relative;
            width: 200px;
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            background: var(--white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: var(--primary);
            color: var(--white);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }
        
        .btn-edit {
            color: var(--secondary);
        }
        
        .btn-edit:hover {
            background-color: rgba(33, 150, 243, 0.1);
        }
        
        .btn-delete {
            color: var(--danger);
        }
        
        .btn-delete:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }
        
        /* Settings Panel */
        .btn-settings {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-settings:hover {
            transform: rotate(30deg);
            background: var(--primary-dark);
        }
        
        .settings-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 99;
            width: 300px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .settings-panel.active {
            transform: translateX(0);
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .settings-title i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .settings-form .form-group {
            margin-bottom: 15px;
        }
        
        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Footer */
        .app-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: var(--gray);
            font-size: 12px;
        }
        
        /* Badge for Transaction Type */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .badge-income {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--primary-dark);
        }
        
        .badge-expense {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        /* Tabs for Report */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--gray);
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary-dark);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Chart Styles */
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        /* Report Styles */
        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .report-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-dark);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-dark);
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        /* Export Buttons */
        .export-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Summary Report */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .stat-title {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }
        
        .stat-income {
            color: var(--primary-dark);
        }
        
        .stat-expense {
            color: var(--danger);
        }
        
        .stat-balance {
            color: var(--secondary);
        }
        
        /* Responsive Table - Scroll Horizontal */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 5px;
                width: 95%;
            }
            
            .dashboard, .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-grid, .report-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: flex;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .search-filter, .report-filters {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-box {
                width: 100%;
            }
            
            /* Table Responsive dengan Scroll Horizontal */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            
            #laporanTable, .report-table {
                min-width: 600px; /* Lebar minimum tabel */
                margin-bottom: 0;
            }
            
            #laporanTable th, 
            #laporanTable td,
            .report-table th,
            .report-table td {
                padding: 8px 10px;
                font-size: 11px;
            }
            
            .action-buttons {
                flex-wrap: nowrap;
            }
            
            .btn-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        /* Tambahkan di bagian responsive CSS */
@media (max-width: 768px) {
    .report-table {
        font-size: 12px;
    }
    
    .report-table th, 
    .report-table td {
        padding: 6px 8px;
    }
    
    .report-stat {
        padding: 10px;
    }
    
    .stat-title {
        font-size: 12px;
    }
    
    .stat-value {
        font-size: 16px;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .report-table {
        font-size: 13px;
    }
}

.filter-group {
    margin-bottom: 15px;
}

.filter-control {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.filter-col {
    flex: 1;
}

@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
    }
    
    .filter-col {
        width: 100%;
    }
}

       
    </style>
</head>
<body onload="loadData()">
    <!-- Settings Button -->
    <button class="btn-settings" onclick="toggleSettings()">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-title">
            <i class="fas fa-cog"></i> Pengaturan Aplikasi
        </div>
        <div class="settings-form">
            <div class="form-group">
                <label for="customTitle">Judul Aplikasi</label>
                <input type="text" id="customTitle" class="form-control" placeholder="Masukkan judul baru">
            </div>
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveTitle()">
                    <i class="fas fa-save"></i> Simpan
                </button>
                <button class="btn btn-danger" onclick="document.getElementById('settingsPanel').classList.remove('active')">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- App Header -->
        <div class="app-header">
            <h1 class="app-title" id="laporanTitle">LAPORAN KEUANGAN HARIAN</h1>
            <p class="tagline">Mengelola keuangan Anda dengan lebih baik</p>
        </div>
        
        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" onclick="openTab('transaksi')">
                <i class="fas fa-exchange-alt"></i> Transaksi
            </div>
            <div class="tab" onclick="openTab('laporan')">
                <i class="fas fa-chart-bar"></i> Laporan
            </div>
        </div>
        
        <!-- Transaksi Tab -->
        <div id="transaksi" class="tab-content active">
            <!-- Dashboard Cards -->
            <div class="dashboard">
                <div class="card card-income">
                    <div class="card-title">
                        <i class="fas fa-wallet"></i> Pemasukan
                    </div>
                    <div class="card-value currency" id="totalPemasukan">Rp 0</div>
                </div>
                
                <div class="card card-expense">
                    <div class="card-title">
                        <i class="fas fa-shopping-bag"></i> Pengeluaran
                    </div>
                    <div class="card-value currency" id="totalPengeluaran">Rp 0</div>
                </div>
                
                <div class="card card-balance">
                    <div class="card-title">
                        <i class="fas fa-piggy-bank"></i> Saldo Akhir
                    </div>
                    <div class="card-value currency" id="saldoAkhir">Rp 0</div>
                </div>
            </div>
            
            <!-- Transaction Form -->
            <div class="form-container">
                <h3 class="form-title">Tambah Transaksi Baru</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tanggal">Tanggal</label>
                        <input type="date" id="tanggal" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="keterangan">Keterangan</label>
                        <input type="text" id="keterangan" class="form-control" placeholder="Deskripsi transaksi">
                    </div>
                    <div class="form-group">
                        <label for="tipe">Jenis Transaksi</label>
                        <select id="tipe" class="form-control">
                            <option value="pemasukan">Pemasukan</option>
                            <option value="pengeluaran">Pengeluaran</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jumlah">Jumlah (Rp)</label>
                        <input type="text" id="jumlah" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="tambahTransaksi()">
                        <i class="fas fa-plus"></i> Tambah
                    </button>
                    <button class="btn btn-warning" onclick="updateTransaksi()">
                        <i class="fas fa-sync"></i> Update
                    </button>
                    <button class="btn btn-danger" onclick="clearData()">
                        <i class="fas fa-trash"></i> Hapus Semua
                    </button>
                </div>
                
                <div class="export-btn-group">
                    <button class="btn btn-secondary" onclick="simpanPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-secondary" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                </div>
            </div>
            
            <!-- Transaction Data -->
            <div class="data-section">
                <h3 class="section-title">Riwayat Transaksi</h3>
                
                <div class="search-filter">
                    <div class="filter-group">
                        <label for="filterType">Filter Berdasarkan:</label>
                        <select id="filterType" class="form-control" onchange="changeFilterType()">
                            <option value="all">Semua Transaksi</option>
                            <option value="date">Tanggal Tertentu</option>
                            <option value="month">Bulan Tertentu</option>
                            <option value="range">Rentang Tanggal</option>
                        </select>
                    </div>
                
                    <!-- Filter Tanggal Tertentu -->
                    <div class="filter-control" id="dateFilterControl" style="display: none;">
                        <label for="filterDate">Pilih Tanggal:</label>
                        <input type="date" id="filterDate" class="form-control" onchange="filterTransactions()">
                    </div>
                
                    <!-- Filter Bulan Tertentu -->
                    <div class="filter-control" id="monthFilterControl" style="display: none;">
                        <div class="filter-row">
                            <div class="filter-col">
                                <label for="filterMonth">Bulan:</label>
                                <select id="filterMonth" class="form-control" onchange="filterTransactions()">
                                    <option value="01">Januari</option>
                                    <option value="02">Februari</option>
                                    <option value="03">Maret</option>
                                    <option value="04">April</option>
                                    <option value="05">Mei</option>
                                    <option value="06">Juni</option>
                                    <option value="07">Juli</option>
                                    <option value="08">Agustus</option>
                                    <option value="09">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                            </div>
                            <div class="filter-col">
                                <label for="filterYear">Tahun:</label>
                                <select id="filterYear" class="form-control" onchange="filterTransactions()">
                                    <!-- Tahun akan diisi oleh JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                
                    <!-- Filter Rentang Tanggal -->
                    <div class="filter-control" id="rangeFilterControl" style="display: none;">
                        <div class="filter-row">
                            <div class="filter-col">
                                <label for="filterStartDate">Dari:</label>
                                <input type="date" id="filterStartDate" class="form-control" onchange="filterTransactions()">
                            </div>
                            <div class="filter-col">
                                <label for="filterEndDate">Sampai:</label>
                                <input type="date" id="filterEndDate" class="form-control" onchange="filterTransactions()">
                            </div>
                        </div>
                    </div>
                
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Cari transaksi..." id="searchInput" oninput="filterTransactions()">
                    </div>
                </div>
                
                <!-- Tambahkan div wrapper untuk tabel -->
                <div class="table-responsive">
                    <table id="laporanTable">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Pemasukan</th>
                                <th>Pengeluaran</th>
                                <th>Saldo</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="data-keuangan"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Laporan Tab -->
        <div id="laporan" class="tab-content">
            <h3 class="section-title">Rekap Laporan Keuangan</h3>
            
            <div class="tabs">
                <div class="tab active" onclick="openReportTab('bulanan')">
                    <i class="fas fa-calendar-alt"></i> Laporan Bulanan
                </div>
                <div class="tab" onclick="openReportTab('tahunan')">
                    <i class="fas fa-calendar-check"></i> Laporan Tahunan
                </div>
            </div>
            
            <!-- Laporan Bulanan -->
            <div id="bulanan" class="tab-content active">
                <div class="report-filters">
                    <div class="form-group">
                        <label for="reportMonth">Pilih Bulan:</label>
                        <select id="reportMonth" class="form-control" onchange="generateMonthlyReport()">
                            <option value="01">Januari</option>
                            <option value="02">Februari</option>
                            <option value="03">Maret</option>
                            <option value="04">April</option>
                            <option value="05">Mei</option>
                            <option value="06">Juni</option>
                            <option value="07">Juli</option>
                            <option value="08">Agustus</option>
                            <option value="09">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportMonthYear">Pilih Tahun:</label>
                        <select id="reportMonthYear" class="form-control" onchange="generateMonthlyReport()">
                            <!-- Akan diisi dengan script -->
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="generateMonthlyReport()">
                        <i class="fas fa-sync"></i> Tampilkan
                    </button>
                    <div class="export-btn-group">
                        <button class="btn btn-secondary" onclick="exportMonthlyPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-secondary" onclick="exportMonthlyExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="report-stat">
                        <div class="stat-title">Total Pemasukan</div>
                        <div class="stat-value stat-income" id="monthlyIncome">Rp 0</div>
                    </div>
                    <div class="report-stat">
                        <div class="stat-title">Total Pengeluaran</div>
                        <div class="stat-value stat-expense" id="monthlyExpense">Rp 0</div>
                    </div>
                    <div class="report-stat">
                        <div class="stat-title">Saldo</div>
                        <div class="stat-value stat-balance" id="monthlyBalance">Rp 0</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                
                
                    <div class="report-card">
                        <h4 class="report-title">Ringkasan Bulanan</h4>
                        <div class="table-responsive">
                            <table class="report-table" id="monthlySummaryTable">
                                <thead>
                                    <tr>
                                        <th>Bulan</th>
                                        <th>Pemasukan</th>
                                        <th>Pengeluaran</th>
                                        <th>Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlySummary"></tbody>
                            </table>
                        </div>
                    </div>
                
                
                <div class="report-card">
                    <h4 class="report-title">Transaksi Bulanan</h4>
                    <div class="table-responsive">
                        <table class="report-table" id="monthlyTransactionsTable">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Keterangan</th>
                                    <th>Pemasukan</th>
                                    <th>Pengeluaran</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyTransactions"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Laporan Tahunan -->
            <div id="tahunan" class="tab-content">
                <div class="report-filters">
                    <div class="form-group">
                        <label for="filterYearAnnual">Pilih Tahun:</label>
                        <select id="filterYearAnnual" class="form-control" onchange="generateAnnualReport()">
                            <!-- Akan diisi dengan script -->
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="generateAnnualReport()">
                        <i class="fas fa-sync"></i> Tampilkan
                    </button>
                    <div class="export-btn-group">
                        <button class="btn btn-secondary" onclick="exportAnnualPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-secondary" onclick="exportAnnualExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="report-stat">
                        <div class="stat-title">Total Pemasukan</div>
                        <div class="stat-value stat-income" id="annualIncome">Rp 0</div>
                    </div>
                    <div class="report-stat">
                        <div class="stat-title">Total Pengeluaran</div>
                        <div class="stat-value stat-expense" id="annualExpense">Rp 0</div>
                    </div>
                    <div class="report-stat">
                        <div class="stat-title">Saldo</div>
                        <div class="stat-value stat-balance" id="annualBalance">Rp 0</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="annualChart"></canvas>
                </div>
                
                
                    <div class="report-card">
                        <h4 class="report-title">Ringkasan Bulanan</h4>
                        <div class="table-responsive">
                            <table class="report-table" id="annualMonthlySummaryTable">
                                <thead>
                                    <tr>
                                        <th>Bulan</th>
                                        <th>Pemasukan</th>
                                        <th>Pengeluaran</th>
                                        <th>Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="annualMonthlySummary"></tbody>
                            </table>
                        </div>
                    </div>
                
            </div>
        </div>
        
        <!-- App Footer -->
        <div class="app-footer">
            <p>Â© 2023 Laporan Keuangan Harian - Dibuat dengan <i class="fas fa-heart" style="color: #f44336;"></i> untuk pengelolaan keuangan yang lebih baik</p>
        </div>
    </div>
    
    <!-- Modal for Transaction Detail -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3 class="modal-title">Detail Transaksi</h3>
            <div id="transactionDetail"></div>
        </div>
    </div>
    
    <script>
        // Deklarasi variabel global
        let transactions = [];
        let editingId = null;
        let monthlyChart = null;
        let annualChart = null;
        let categoryChart = null;
        
        // Inisialisasi jsPDF
        const { jsPDF } = window.jspdf;
        
        // Fungsi untuk memuat data dari localStorage
        function loadData() {
            const savedData = localStorage.getItem('financialTransactions');
            const savedTitle = localStorage.getItem('appTitle');
            
            if (savedData) {
        transactions = JSON.parse(savedData);
        updateTransactionTable();
        calculateTotals();
    }
    
    if (savedTitle) {
        document.getElementById('laporanTitle').textContent = savedTitle;
    } else {
        // Set default title if not exists
        localStorage.setItem('appTitle', 'Laporan Keuangan Harian');
    }
            
            // Isi tahun untuk filter
            fillYearDropdowns();
            initReportYearFilter(); // Untuk laporan bulanan
            initAnnualYearFilter(); // Untuk laporan tahunan
            
             // Set bulan dan tahun saat ini
             const currentDate = new Date();
            document.getElementById('tanggal').valueAsDate = currentDate;
            document.getElementById('reportMonth').value = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('reportMonthYear').value = currentDate.getFullYear();
            document.getElementById('filterYearAnnual').value = currentDate.getFullYear();
            
            // Generate laporan awal
            generateMonthlyReport();
            
            // Setup input jumlah
            setupAmountInput();
        }
        
        // Setup input jumlah dengan formatter
        function setupAmountInput() {
            const amountInput = document.getElementById('jumlah');
            
            // Format saat input
            amountInput.addEventListener('input', function(e) {
                formatInputNumber(this);
            });
            
            // Handle paste
            amountInput.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const numericString = pastedText.replace(/[^\d]/g, '');
                document.execCommand('insertText', false, numericString);
                formatInputNumber(this);
            });
        }
        
        // Fungsi untuk memformat input dengan separator ribuan tanpa batas
        function formatInputNumber(input) {
            // Simpan posisi kursor dan nilai sebelum perubahan
            const cursorPosition = input.selectionStart;
            const originalValue = input.value;
            const originalLength = originalValue.length;
            
            // Dapatkan angka saja (hapus semua non-digit)
            let numericString = originalValue.replace(/[^\d]/g, '');
            
            // Jika kosong, set ke string kosong
            if (numericString === '') {
                input.value = '';
                return;
            }
            
            // Format dengan separator ribuan menggunakan BigInt untuk nilai sangat besar
            const formattedValue = new Intl.NumberFormat('id-ID').format(BigInt(numericString));
            
            // Update nilai input
            input.value = formattedValue;
            
            // Hitung posisi kursor baru
            let newCursorPosition = cursorPosition;
            
            // Adjust cursor position based on added/removed separators
            const separatorDiff = (formattedValue.match(/\./g)?.length || 0) - (originalValue.match(/\./g)?.length || 0);
            newCursorPosition = cursorPosition + separatorDiff;
            
            // Pastikan posisi kursor valid
            newCursorPosition = Math.max(0, Math.min(newCursorPosition, formattedValue.length));
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }
        
        // Fungsi untuk mendapatkan nilai numerik (string)
        function getNumericValue(formattedValue) {
            return formattedValue.replace(/[^\d]/g, '') || '0';
        }
        
        // Fungsi untuk mengisi dropdown tahun
        function fillYearDropdowns() {
    const currentYear = new Date().getFullYear();
    
    // Update untuk semua dropdown tahun di aplikasi
    const yearDropdowns = [
        document.getElementById('filterYear'),         // Filter bulanan
        document.getElementById('filterYearAnnual'),   // Filter tahunan
        document.getElementById('reportMonthYear')     // Laporan bulanan
    ];
    
    yearDropdowns.forEach(dropdown => {
        if (!dropdown) return;
        
        // Kosongkan dropdown
        dropdown.innerHTML = '';
        
        // Tambahkan tahun dari currentYear - 5 hingga 2030
        for (let year = currentYear - 5; year <= 2030; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            
            // Set tahun saat ini sebagai selected
            if (year === currentYear) {
                option.selected = true;
            }
            
            dropdown.appendChild(option);
        }
    });
}

        
        // Fungsi untuk menambah transaksi baru dengan penanganan jumlah tanpa batas
        function tambahTransaksi() {
            const tanggal = document.getElementById('tanggal').value;
            const keterangan = document.getElementById('keterangan').value.trim();
            const tipe = document.getElementById('tipe').value;
            const jumlahInput = document.getElementById('jumlah');
            const jumlah = getNumericValue(jumlahInput.value);
            
            // Validasi input
            if (!tanggal || !keterangan || jumlah === '0') {
                alert('Harap isi semua field dengan benar!');
                return;
            }
            
            // Konversi ke number (BigInt jika perlu)
            const amount = Number(jumlah);
            
            // Buat objek transaksi
            const transaction = {
                id: Date.now(),
                tanggal,
                keterangan,
                tipe,
                jumlah: amount,
                saldo: 0 // Akan dihitung saat update
            };
            
            // Tambahkan ke array
            transactions.push(transaction);
            
            // Simpan ke localStorage
            saveData();
            
            // Update tampilan
            updateTransactionTable();
            calculateTotals();
            
            // Reset form
            document.getElementById('keterangan').value = '';
            document.getElementById('jumlah').value = '';
            document.getElementById('keterangan').focus();
        }
        
        // Fungsi untuk mengupdate transaksi dengan penanganan jumlah tanpa batas
        function updateTransaksi() {
            if (editingId === null) {
                alert('Tidak ada transaksi yang dipilih untuk diupdate!');
                return;
            }
            
            const tanggal = document.getElementById('tanggal').value;
            const keterangan = document.getElementById('keterangan').value.trim();
            const tipe = document.getElementById('tipe').value;
            const jumlahInput = document.getElementById('jumlah');
            const jumlah = getNumericValue(jumlahInput.value);
            
            // Validasi input
            if (!tanggal || !keterangan || jumlah === '0') {
                alert('Harap isi semua field dengan benar!');
                return;
            }
            
            // Konversi ke number
            const amount = Number(jumlah);
            
            // Cari transaksi yang akan diupdate
            const index = transactions.findIndex(t => t.id === editingId);
            if (index !== -1) {
                transactions[index] = {
                    id: editingId,
                    tanggal,
                    keterangan,
                    tipe,
                    jumlah: amount,
                    saldo: 0 // Akan dihitung saat update
                };
                
                // Simpan ke localStorage
                saveData();
                
                // Update tampilan
                updateTransactionTable();
                calculateTotals();
                
                // Reset form dan editingId
                resetForm();
            }
        }
        
        // Fungsi untuk mengedit transaksi
        function editTransaksi(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                editingId = id;
                
                // Isi form dengan data transaksi
                document.getElementById('tanggal').value = transaction.tanggal;
                document.getElementById('keterangan').value = transaction.keterangan;
                document.getElementById('tipe').value = transaction.tipe;
                
                // Format jumlah dengan separator ribuan
                document.getElementById('jumlah').value = new Intl.NumberFormat('id-ID').format(transaction.jumlah);
                
                // Scroll ke form
                document.getElementById('tanggal').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Fungsi untuk menghapus transaksi
        function deleteTransaksi(id) {
            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                transactions = transactions.filter(t => t.id !== id);
                
                // Simpan ke localStorage
                saveData();
                
                // Update tampilan
                updateTransactionTable();
                calculateTotals();
                
                // Reset form jika yang dihapus sedang diedit
                if (editingId === id) {
                    resetForm();
                }
            }
        }
        
        // Fungsi untuk menampilkan detail transaksi
        function showTransactionDetail(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                const modal = document.getElementById('transactionModal');
                const detailDiv = document.getElementById('transactionDetail');
                
                // Format tanggal
                const date = new Date(transaction.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Buat konten detail
                detailDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Tanggal:</strong> ${formattedDate}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Keterangan:</strong> ${transaction.keterangan}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Jenis:</strong> 
                        <span class="badge ${transaction.tipe === 'pemasukan' ? 'badge-income' : 'badge-expense'}">
                            ${transaction.tipe === 'pemasukan' ? 'Pemasukan' : 'Pengeluaran'}
                        </span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Jumlah:</strong> ${formatCurrency(transaction.jumlah)}
                    </div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="editTransaksi(${transaction.id}); closeModal()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteTransaksi(${transaction.id}); closeModal()">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;
                
                // Tampilkan modal
                modal.style.display = 'flex';
            }
        }
        
        // Fungsi untuk menutup modal
        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
        }
        
        // Fungsi untuk mereset form
        function resetForm() {
            editingId = null;
            document.getElementById('tanggal').valueAsDate = new Date();
            document.getElementById('keterangan').value = '';
            document.getElementById('tipe').value = 'pemasukan';
            document.getElementById('jumlah').value = '';
        }
        
        // Fungsi untuk menghapus semua data
        function clearData() {
            if (confirm('Apakah Anda yakin ingin menghapus SEMUA data transaksi? Aksi ini tidak dapat dibatalkan!')) {
                transactions = [];
                saveData();
                updateTransactionTable();
                calculateTotals();
                resetForm();
            }
        }
        
        // Fungsi untuk menyimpan data ke localStorage
        function saveData() {
            localStorage.setItem('financialTransactions', JSON.stringify(transactions));
        }
        
        function updateTransactionTable(filteredTransactions = null) {
    const tbody = document.getElementById('data-keuangan');
    tbody.innerHTML = '';
    
    const dataToDisplay = filteredTransactions || transactions;
    
    // Urutkan dari terlama ke terbaru (ascending)
    const sortedTransactions = [...dataToDisplay].sort((a, b) => {
        return new Date(a.tanggal) - new Date(b.tanggal);
    });
    
    // Hitung saldo berjalan
    let runningBalance = 0;
    const transactionsWithBalance = sortedTransactions.map(transaction => {
        if (transaction.tipe === 'pemasukan') {
            runningBalance += transaction.jumlah;
        } else {
            runningBalance -= transaction.jumlah;
        }
        return { ...transaction, saldo: runningBalance };
    });
    
    // Isi tabel
    transactionsWithBalance.forEach(transaction => {
        const row = document.createElement('tr');
        row.onclick = () => showTransactionDetail(transaction.id);
        row.style.cursor = 'pointer';
        
        // Format tanggal
        const date = new Date(transaction.tanggal);
        const formattedDate = date.toLocaleDateString('id-ID', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        
        // Tampilkan jumlah berdasarkan jenis transaksi
        const pemasukan = transaction.tipe === 'pemasukan' ? formatCurrency(transaction.jumlah) : '-';
        const pengeluaran = transaction.tipe === 'pengeluaran' ? formatCurrency(transaction.jumlah) : '-';
        
        row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${transaction.keterangan}</td>
            <td style="color: var(--primary-dark); font-weight: 500;">${pemasukan}</td>
            <td style="color: var(--danger); font-weight: 500;">${pengeluaran}</td>
            <td style="font-weight: 600;">${formatCurrency(transaction.saldo)}</td>
            <td class="action-buttons">
                <button class="btn-icon btn-edit" onclick="event.stopPropagation(); editTransaksi(${transaction.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteTransaksi(${transaction.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}
        
        // Fungsi untuk menghitung total pemasukan, pengeluaran, dan saldo
        function calculateTotals() {
            calculateFilteredTotals(transactions);
            let totalPemasukan = 0;
            let totalPengeluaran = 0;
            
            transactions.forEach(transaction => {
                if (transaction.tipe === 'pemasukan') {
                    totalPemasukan += transaction.jumlah;
                } else {
                    totalPengeluaran += transaction.jumlah;
                }
            });
            
            const saldoAkhir = totalPemasukan - totalPengeluaran;
            
            // Update tampilan
            document.getElementById('totalPemasukan').textContent = formatCurrency(totalPemasukan);
            document.getElementById('totalPengeluaran').textContent = formatCurrency(totalPengeluaran);
            document.getElementById('saldoAkhir').textContent = formatCurrency(saldoAkhir);
        }
        
        // Fungsi untuk memfilter data berdasarkan tanggal
        function filterData() {
            const dateFilter = document.getElementById('searchDate').value;
            
            if (!dateFilter) {
                updateTransactionTable();
                return;
            }
            
            const filteredTransactions = transactions.filter(transaction => {
                return transaction.tanggal === dateFilter;
            });
            
            updateTransactionTable(filteredTransactions);
        }
        
        // Fungsi untuk mencari transaksi berdasarkan kata kunci
        function searchTransaction() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                updateTransactionTable();
                return;
            }
            
            const filteredTransactions = transactions.filter(transaction => {
                return (
                    transaction.keterangan.toLowerCase().includes(searchTerm) ||
                    transaction.jumlah.toString().includes(searchTerm) ||
                    transaction.tanggal.includes(searchTerm)
                );
            });
            
            updateTransactionTable(filteredTransactions);
        }
        
        // Fungsi untuk mengubah angka menjadi format mata uang tanpa desimal
        function formatCurrency(amount) {
            return 'Rp ' + Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        // Fungsi untuk toggle settings panel
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }
        
        // Fungsi untuk menyimpan judul aplikasi
        function saveTitle() {
            const newTitle = document.getElementById('customTitle').value.trim();
            if (newTitle) {
                document.getElementById('laporanTitle').textContent = newTitle;
                localStorage.setItem('appTitle', newTitle);
                document.getElementById('settingsPanel').classList.remove('active');
                document.getElementById('customTitle').value = '';
            }
        }
        
        // Fungsi untuk membuka tab
        function openTab(tabName) {
            // Sembunyikan semua tab content
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Nonaktifkan semua tab
            const tabs = document.querySelectorAll('.tabs .tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Aktifkan tab yang dipilih
            document.getElementById(tabName).classList.add('active');
            
            // Temukan tab yang sesuai dan aktifkan
            const tabButtons = document.querySelectorAll('.tabs .tab');
            tabButtons.forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Jika membuka tab laporan, generate laporan terbaru
            if (tabName === 'laporan') {
                generateMonthlyReport();
            }
        }
        
        // Fungsi untuk membuka tab laporan
        function openReportTab(reportTabName) {
            // Sembunyikan semua tab content
            const reportTabContents = document.querySelectorAll('#laporan .tab-content');
            reportTabContents.forEach(tab => tab.classList.remove('active'));
            
            // Nonaktifkan semua tab
            const reportTabs = document.querySelectorAll('#laporan .tabs .tab');
            reportTabs.forEach(tab => tab.classList.remove('active'));
            
            // Aktifkan tab yang dipilih
            document.getElementById(reportTabName).classList.add('active');
            
            // Temukan tab yang sesuai dan aktifkan
            reportTabs.forEach(tab => {
                if (tab.getAttribute('onclick').includes(reportTabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Generate laporan yang sesuai
            if (reportTabName === 'bulanan') {
                generateMonthlyReport();
            } else if (reportTabName === 'tahunan') {
                generateAnnualReport();
            }
        }
        
        // Fungsi untuk menghasilkan laporan bulanan
        function generateMonthlyReport() {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportMonthYear').value;
            
            // Filter transaksi berdasarkan bulan dan tahun
            const filteredTransactions = transactions.filter(transaction => {
                const [tYear, tMonth] = transaction.tanggal.split('-');
                return tYear === year && tMonth === month;
            });
            
            // Hitung total pemasukan dan pengeluaran
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredTransactions.forEach(transaction => {
                if (transaction.tipe === 'pemasukan') {
                    totalIncome += transaction.jumlah;
                } else {
                    totalExpense += transaction.jumlah;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // Update ringkasan
            document.getElementById('monthlyIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('monthlyExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('monthlyBalance').textContent = formatCurrency(balance);
            
            // Tampilkan ringkasan bulanan
            updateMonthlySummary(month, year, totalIncome, totalExpense, balance);
            
            // Tampilkan semua transaksi bulanan
            showMonthlyTransactions(filteredTransactions);
            
            // Buat chart bulanan
            createMonthlyChart(filteredTransactions);
        }
        
        function updateMonthlySummary(month, year, totalIncome, totalExpense, balance) {
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const monthlySummaryTbody = document.getElementById('monthlySummary');
            monthlySummaryTbody.innerHTML = '';
            
            const row = document.createElement('tr');
            const monthName = monthNames[parseInt(month) - 1];
            
            row.innerHTML = `
                <td>${monthName} ${year}</td>
                <td style="color: var(--primary-dark);">${formatCurrency(totalIncome)}</td>
                <td style="color: var(--danger);">${formatCurrency(totalExpense)}</td>
                <td style="font-weight: 600;">${formatCurrency(balance)}</td>
            `;
            
            monthlySummaryTbody.appendChild(row);
        }
        
        function showMonthlyTransactions(transactions) {
    const monthTbody = document.getElementById('monthlyTransactions');
    monthTbody.innerHTML = '';
    
    if (transactions.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" style="text-align: center;">Tidak ada transaksi untuk bulan ini</td>';
        monthTbody.appendChild(row);
        return;
    }
    
    // Urutkan dari terlama ke terbaru (ascending)
    const sortedTransactions = [...transactions].sort((a, b) => {
        return new Date(a.tanggal) - new Date(b.tanggal);
    });
    
    // Hitung saldo berjalan
    let runningBalance = 0;
    const transactionsWithBalance = sortedTransactions.map(transaction => {
        if (transaction.tipe === 'pemasukan') {
            runningBalance += transaction.jumlah;
        } else {
            runningBalance -= transaction.jumlah;
        }
        return { ...transaction, saldo: runningBalance };
    });
    
    // Tampilkan transaksi
    transactionsWithBalance.forEach(transaction => {
        const row = document.createElement('tr');
        const date = new Date(transaction.tanggal);
        const formattedDate = date.toLocaleDateString('id-ID', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
        
        // Format kolom pemasukan dan pengeluaran
        const pemasukan = transaction.tipe === 'pemasukan' ? formatCurrency(transaction.jumlah) : '-';
        const pengeluaran = transaction.tipe === 'pengeluaran' ? formatCurrency(transaction.jumlah) : '-';
        
        row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${transaction.keterangan}</td>
            <td style="color: var(--primary-dark); font-weight: 500;">${pemasukan}</td>
            <td style="color: var(--danger); font-weight: 500;">${pengeluaran}</td>
            <td style="font-weight: 600;">${formatCurrency(transaction.saldo)}</td>
        `;
        
        monthTbody.appendChild(row);
    });
}
        
        function createMonthlyChart(transactions) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Kelompokkan transaksi per hari
            const dailyData = {};
            
            transactions.forEach(transaction => {
                const date = transaction.tanggal.split('-')[2]; // Ambil tanggal saja
                if (!dailyData[date]) {
                    dailyData[date] = { income: 0, expense: 0 };
                }
                
                if (transaction.tipe === 'pemasukan') {
                    dailyData[date].income += transaction.jumlah;
                } else {
                    dailyData[date].expense += transaction.jumlah;
                }
            });
            
            // Siapkan data untuk chart
            const labels = Object.keys(dailyData).sort();
            const incomeData = [];
            const expenseData = [];
            
            labels.forEach(date => {
                incomeData.push(dailyData[date].income);
                expenseData.push(dailyData[date].expense);
            });
            
            // Hancurkan chart sebelumnya jika ada
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            // Buat chart baru
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            backgroundColor: 'rgba(76, 175, 80, 0.7)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            backgroundColor: 'rgba(244, 67, 54, 0.7)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'Rp ' + context.raw.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Fungsi untuk menghasilkan laporan tahunan
        function generateAnnualReport() {
            const year = document.getElementById('filterYearAnnual').value;
            
            // Filter transaksi berdasarkan tahun
            const filteredTransactions = transactions.filter(transaction => {
                const [tYear] = transaction.tanggal.split('-');
                return tYear === year;
            });
            
            // Hitung total pemasukan dan pengeluaran
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredTransactions.forEach(transaction => {
                if (transaction.tipe === 'pemasukan') {
                    totalIncome += transaction.jumlah;
                } else {
                    totalExpense += transaction.jumlah;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // Update ringkasan
            document.getElementById('annualIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('annualExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('annualBalance').textContent = formatCurrency(balance);
            
            // Buat ringkasan bulanan
            const monthlySummary = {};
            filteredTransactions.forEach(transaction => {
                const month = transaction.tanggal.split('-')[1];
                if (!monthlySummary[month]) {
                    monthlySummary[month] = {
                        income: 0,
                        expense: 0
                    };
                }
                
                if (transaction.tipe === 'pemasukan') {
                    monthlySummary[month].income += transaction.jumlah;
                } else {
                    monthlySummary[month].expense += transaction.jumlah;
                }
            });
            
            // Tampilkan ringkasan bulanan
            const monthlySummaryTbody = document.getElementById('annualMonthlySummary');
            monthlySummaryTbody.innerHTML = '';
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            for (let month = 1; month <= 12; month++) {
                const monthKey = month.toString().padStart(2, '0');
                const monthData = monthlySummary[monthKey] || { income: 0, expense: 0 };
                const monthBalance = monthData.income - monthData.expense;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthNames[month - 1]}</td>
                    <td style="color: var(--primary-dark);">${formatCurrency(monthData.income)}</td>
                    <td style="color: var(--danger);">${formatCurrency(monthData.expense)}</td>
                    <td style="font-weight: 600;">${formatCurrency(monthBalance)}</td>
                `;
                
                monthlySummaryTbody.appendChild(row);
            }
            
            // Buat chart tahunan
            createAnnualChart(monthlySummary);
            
            // Buat chart kategori pengeluaran
            createCategoryChart(filteredTransactions);
        }
        
        // Fungsi untuk membuat chart tahunan
        function createAnnualChart(monthlySummary) {
            const ctx = document.getElementById('annualChart').getContext('2d');
            
            // Siapkan data untuk chart
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 
                               'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
            const incomeData = [];
            const expenseData = [];
            
            for (let month = 1; month <= 12; month++) {
                const monthKey = month.toString().padStart(2, '0');
                const monthData = monthlySummary[monthKey] || { income: 0, expense: 0 };
                incomeData.push(monthData.income);
                expenseData.push(monthData.expense);
            }
            
            // Hancurkan chart sebelumnya jika ada
            if (annualChart) {
                annualChart.destroy();
            }
            
            // Buat chart baru
            annualChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            backgroundColor: 'rgba(76, 175, 80, 0.2)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            backgroundColor: 'rgba(244, 67, 54, 0.2)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'Rp ' + context.raw.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Fungsi untuk membuat chart kategori pengeluaran
        function createCategoryChart(transactions) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Kategorikan pengeluaran berdasarkan keyword dalam keterangan
            const categories = {
                'Makanan': ['makan', 'restoran', 'warung', 'kafe', 'minum', 'kopi', 'nasi'],
                'Transportasi': ['transport', 'bensin', 'ojol', 'taksi', 'angkot', 'bus', 'kereta'],
                'Belanja': ['belanja', 'mall', 'supermarket', 'pasar', 'baju', 'celana', 'sepatu'],
                'Hiburan': ['hiburan', 'nonton', 'film', 'konser', 'game', 'hobi'],
                'Tagihan': ['listrik', 'air', 'internet', 'pulsa', 'tv', 'kabel', 'asuransi'],
                'Lainnya': [] // Default category
            };
            
            const categoryTotals = {};
            Object.keys(categories).forEach(cat => {
                categoryTotals[cat] = 0;
            });
            
            // Hitung total pengeluaran per kategori
            transactions.forEach(transaction => {
                if (transaction.tipe === 'pengeluaran') {
                    let categorized = false;
                    const desc = transaction.keterangan.toLowerCase();
                    
                    for (const [category, keywords] of Object.entries(categories)) {
                        if (keywords.some(keyword => desc.includes(keyword))) {
                            categoryTotals[category] += transaction.jumlah;
                            categorized = true;
                            break;
                        }
                    }
                    
                    if (!categorized) {
                        categoryTotals['Lainnya'] += transaction.jumlah;
                    }
                }
            });
            
            // Siapkan data untuk chart (hanya kategori dengan nilai > 0)
            const labels = [];
            const data = [];
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)'
            ];
            const borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ];
            
            let colorIndex = 0;
            for (const [category, total] of Object.entries(categoryTotals)) {
                if (total > 0) {
                    labels.push(category);
                    data.push(total);
                    colorIndex = (colorIndex + 1) % backgroundColors.length;
                }
            }
            
            // Hancurkan chart sebelumnya jika ada
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            // Buat chart baru jika ada data
            if (data.length > 0) {
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors.slice(0, labels.length),
                            borderColor: borderColors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: Rp ${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            } else {
                // Jika tidak ada data pengeluaran, tampilkan pesan
                ctx.font = '16px Poppins';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('Tidak ada data pengeluaran', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        }
        
        // Fungsi untuk menyimpan laporan ke PDF
        function simpanPDF() {
    const doc = new jsPDF({
        orientation: window.innerWidth < 768 ? 'portrait' : 'potrait'
    });

    // Dapatkan judul dari pengaturan
    const appTitle = getAppTitle();

    // Judul laporan
    doc.setFontSize(16);
    doc.setTextColor(46, 125, 50);
    doc.text(appTitle.toUpperCase(), doc.internal.pageSize.width / 2, 15, { align: 'center' });

    // Tanggal cetak
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    const today = new Date();
    doc.text(`Dicetak pada: ${today.toLocaleDateString('id-ID')} ${today.toLocaleTimeString('id-ID')}`, 
             doc.internal.pageSize.width / 2, 22, { align: 'center' });

    // Ringkasan keuangan
    doc.setFontSize(12);
    doc.setTextColor(33, 37, 41);
    doc.text('Ringkasan Keuangan', 14, 30);
    doc.setDrawColor(76, 175, 80);
    doc.setLineWidth(0.3);
    doc.line(14, 32, 50, 32);

    // Data ringkasan
    doc.setFontSize(10);
    doc.text(`Total Pemasukan: ${document.getElementById('totalPemasukan').textContent}`, 14, 38);
    doc.text(`Total Pengeluaran: ${document.getElementById('totalPengeluaran').textContent}`, 14, 44);
    doc.text(`Saldo Akhir: ${document.getElementById('saldoAkhir').textContent}`, 14, 50);

    // Data transaksi
    doc.setFontSize(12);
    doc.text('Daftar Transaksi', 14, 60);
    doc.line(14, 62, 45, 62);

    // Buat tabel transaksi dengan pengaturan kolom responsif
    const isMobile = window.innerWidth < 768;
    const columnStyles = isMobile ? {
        0: { cellWidth: 15 },
        1: { cellWidth: 40 },
        2: { cellWidth: 25 },
        3: { cellWidth: 25 },
        4: { cellWidth: 25 }
    } : {
        0: { cellWidth: 20 },
        1: { cellWidth: 60 },
        2: { cellWidth: 30 },
        3: { cellWidth: 30 },
        4: { cellWidth: 30 }
    };

    const headers = [['Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran', 'Saldo']];
    const data = [];

    const rows = document.querySelectorAll('#laporanTable tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        data.push([
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent,
            cells[4].textContent
        ]);
    });

    // Tambahkan tabel ke PDF
    doc.autoTable({
        startY: 65,
        head: headers,
        body: data,
        headStyles: {
            fillColor: [76, 175, 80],
            textColor: [255, 255, 255],
            fontSize: isMobile ? 8 : 9,
            cellPadding: 2
        },
        bodyStyles: {
            fontSize: isMobile ? 7 : 8,
            cellPadding: 2
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        },
        styles: {
            overflow: 'linebreak',
            halign: 'left'
        },
        columnStyles: columnStyles,
        margin: { left: 10, right: 10 }
    });

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Halaman ${i} dari ${pageCount}`, 
                doc.internal.pageSize.width / 2, 
                doc.internal.pageSize.height - 10, 
                { align: 'center' });
    }

    // Simpan PDF
    doc.save(`Laporan Keuangan - ${today.toLocaleDateString('id-ID')}.pdf`);
}
        
      // Fungsi untuk mengekspor data ke Excel (diperbarui)
      function exportExcel() {
    // Siapkan data untuk workbook
    const wb = XLSX.utils.book_new();
    const title = getAppTitle();
    const today = new Date();
    
    // Data transaksi dengan format lengkap
    const transaksiData = [
        [title.toUpperCase()], // Judul dari pengaturan
        ['Dicetak pada: ' + today.toLocaleDateString('id-ID') + ' ' + today.toLocaleTimeString('id-ID')],
        [''],
        ['Ringkasan Keuangan'],
        ['Total Pemasukan', document.getElementById('totalPemasukan').textContent],
        ['Total Pengeluaran', document.getElementById('totalPengeluaran').textContent],
        ['Saldo Akhir', document.getElementById('saldoAkhir').textContent],
        [''],
        ['Daftar Transaksi'],
        ['No.', 'Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran', 'Saldo'] // Header dengan nomor urut
    ];

    // Tambahkan data transaksi dengan nomor urut
    const rows = document.querySelectorAll('#laporanTable tbody tr');
    let rowNumber = 1;
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        transaksiData.push([
            rowNumber++,
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent,
            cells[4].textContent
        ]);
    });

    // Buat worksheet
    const ws = XLSX.utils.aoa_to_sheet(transaksiData);
    
    // Atur lebar kolom
    ws['!cols'] = [
        {wch: 5},  // No.
        {wch: 12}, // Tanggal
        {wch: 40}, // Keterangan
        {wch: 15}, // Pemasukan
        {wch: 15}, // Pengeluaran
        {wch: 15}  // Saldo
    ];

    // Gabungkan sel untuk judul
    ws['!merges'] = [
        XLSX.utils.decode_range("A1:F1"), // Judul utama
        XLSX.utils.decode_range("A2:F2"), // Tanggal cetak
        XLSX.utils.decode_range("A4:F4"), // Header ringkasan
        XLSX.utils.decode_range("A8:F8")  // Header transaksi
    ];

    // Tambahkan border ke seluruh tabel
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 8; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = {c:C, r:R};
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            
            if (!ws[cell_ref]) continue;
            
            // Set border style
            ws[cell_ref].s = {
                border: {
                    top: {style: "thin", color: {auto: 1}},
                    bottom: {style: "thin", color: {auto: 1}},
                    left: {style: "thin", color: {auto: 1}},
                    right: {style: "thin", color: {auto: 1}}
                }
            };
        }
    }

    // Style untuk header tabel
    for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell_address = {c:C, r:8};
        const cell_ref = XLSX.utils.encode_cell(cell_address);
        
        if (!ws[cell_ref]) continue;
        
        ws[cell_ref].s = {
            font: {bold: true, color: {rgb: "FFFFFF"}},
            fill: {fgColor: {rgb: "4CAF50"}},
            alignment: {horizontal: "center"},
            border: {
                top: {style: "thin", color: {auto: 1}},
                bottom: {style: "thin", color: {auto: 1}},
                left: {style: "thin", color: {auto: 1}},
                right: {style: "thin", color: {auto: 1}}
            }
        };
    }

    // Tambahkan worksheet ke workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Laporan Keuangan');
    
    // Simpan file
    XLSX.writeFile(wb, `${title} - ${today.toLocaleDateString('id-ID')}.xlsx`);
}

        
        // Fungsi untuk export laporan bulanan ke PDF
        function exportMonthlyPDF() {
    const doc = new jsPDF({
        orientation: window.innerWidth < 768 ? 'portrait' : 'potrait'
    });
    
    const appTitle = getAppTitle();
    const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportMonthYear').value;
    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                       'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    const monthName = monthNames[parseInt(month) - 1];
    
   // Judul laporan
   doc.setFontSize(16);
    doc.setTextColor(46, 125, 50);
    doc.text(`${appTitle.toUpperCase()} - BULAN ${monthName} ${year}`, doc.internal.pageSize.width / 2, 15, { align: 'center' });
    
    // Tanggal cetak
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    const today = new Date();
    doc.text(`Dicetak pada: ${today.toLocaleDateString('id-ID')} ${today.toLocaleTimeString('id-ID')}`, 
             doc.internal.pageSize.width / 2, 22, { align: 'center' });
    
    // Ringkasan keuangan
    doc.setFontSize(12);
    doc.setTextColor(33, 37, 41);
    doc.text('Ringkasan Keuangan', 14, 30);
    doc.setDrawColor(76, 175, 80);
    doc.setLineWidth(0.3);
    doc.line(14, 32, 50, 32);
    
    // Data ringkasan
    doc.setFontSize(10);
    doc.text(`Total Pemasukan: ${document.getElementById('monthlyIncome').textContent}`, 14, 38);
    doc.text(`Total Pengeluaran: ${document.getElementById('monthlyExpense').textContent}`, 14, 44);
    doc.text(`Saldo: ${document.getElementById('monthlyBalance').textContent}`, 14, 50);
    
    // Transaksi bulanan
    doc.setFontSize(12);
    doc.text('Daftar Transaksi', 14, 60);
    doc.line(14, 62, 45, 62);
    
    // Buat tabel transaksi dengan pengaturan kolom responsif
    const isMobile = window.innerWidth < 768;
    const columnStyles = isMobile ? {
        0: { cellWidth: 15 },
        1: { cellWidth: 40 },
        2: { cellWidth: 25 },
        3: { cellWidth: 25 },
        4: { cellWidth: 25 }
    } : {
        0: { cellWidth: 20 },
        1: { cellWidth: 60 },
        2: { cellWidth: 30 },
        3: { cellWidth: 30 },
        4: { cellWidth: 30 }
    };
    
    const headers = [['Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran', 'Saldo']];
    const data = [];
    
    const rows = document.querySelectorAll('#monthlyTransactionsTable tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        data.push([
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent,
            cells[4].textContent
        ]);
    });
    
    // Tambahkan tabel ke PDF
    doc.autoTable({
        startY: 65,
        head: headers,
        body: data,
        headStyles: {
            fillColor: [76, 175, 80],
            textColor: [255, 255, 255],
            fontSize: isMobile ? 8 : 9,
            cellPadding: 2
        },
        bodyStyles: {
            fontSize: isMobile ? 7 : 8,
            cellPadding: 2
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        },
        styles: {
            overflow: 'linebreak',
            halign: 'left'
        },
        columnStyles: columnStyles,
        margin: { left: 10, right: 10 }
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Halaman ${i} dari ${pageCount}`, 
                doc.internal.pageSize.width / 2, 
                doc.internal.pageSize.height - 10, 
                { align: 'center' });
    }
    
    // Simpan PDF
    doc.save(`Laporan Bulanan ${monthName} ${year}.pdf`);
}
        
       // Fungsi untuk export laporan bulanan ke Excel (diperbarui)
       function exportMonthlyExcel() {
    const month = document.getElementById('reportMonth').value;
    const year = document.getElementById('reportMonthYear').value;
    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                       'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    const monthName = monthNames[parseInt(month) - 1];
    const title = getAppTitle();
    const today = new Date();

    // Siapkan data untuk workbook
    const wb = XLSX.utils.book_new();
    
    // Data dengan format lengkap
    const reportData = [
        [`${title.toUpperCase()} - BULAN ${monthName} ${year}`],
        ['Dicetak pada: ' + today.toLocaleDateString('id-ID') + ' ' + today.toLocaleTimeString('id-ID')],
        [''],
        ['Ringkasan Keuangan'],
        ['Total Pemasukan', document.getElementById('monthlyIncome').textContent],
        ['Total Pengeluaran', document.getElementById('monthlyExpense').textContent],
        ['Saldo', document.getElementById('monthlyBalance').textContent],
        [''],
        ['Ringkasan Bulanan'],
        ['Bulan', 'Pemasukan', 'Pengeluaran', 'Saldo'],
        [`${monthName} ${year}`, 
         document.getElementById('monthlyIncome').textContent, 
         document.getElementById('monthlyExpense').textContent, 
         document.getElementById('monthlyBalance').textContent],
        [''],
        ['Daftar Transaksi'],
        ['No.', 'Tanggal', 'Keterangan', 'Pemasukan', 'Pengeluaran', 'Saldo']
    ];
    
    // Tambahkan data transaksi bulanan dengan nomor urut
    const rows = document.querySelectorAll('#monthlyTransactionsTable tbody tr');
    let rowNumber = 1;
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        reportData.push([
            rowNumber++,
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent,
            cells[4].textContent
        ]);
    });
    
    // Buat worksheet
    const ws = XLSX.utils.aoa_to_sheet(reportData);
    
    // Atur lebar kolom
    ws['!cols'] = [
        {wch: 5},  // No.
        {wch: 12}, // Tanggal
        {wch: 40}, // Keterangan
        {wch: 15}, // Pemasukan
        {wch: 15}, // Pengeluaran
        {wch: 15}  // Saldo
    ];

    // Gabungkan sel untuk judul dan header
    ws['!merges'] = [
        XLSX.utils.decode_range("A1:F1"),
        XLSX.utils.decode_range("A2:F2"),
        XLSX.utils.decode_range("A4:F4"),
        XLSX.utils.decode_range("A8:D8"),
        XLSX.utils.decode_range("A10:D10"),
        XLSX.utils.decode_range("A12:F12")
    ];

    // Tambahkan border ke seluruh tabel transaksi
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 12; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = {c:C, r:R};
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            
            if (!ws[cell_ref]) continue;
            
            ws[cell_ref].s = {
                border: {
                    top: {style: "thin", color: {auto: 1}},
                    bottom: {style: "thin", color: {auto: 1}},
                    left: {style: "thin", color: {auto: 1}},
                    right: {style: "thin", color: {auto: 1}}
                }
            };
        }
    }

    // Style untuk header tabel transaksi
    for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell_address = {c:C, r:12};
        const cell_ref = XLSX.utils.encode_cell(cell_address);
        
        if (!ws[cell_ref]) continue;
        
        ws[cell_ref].s = {
            font: {bold: true, color: {rgb: "FFFFFF"}},
            fill: {fgColor: {rgb: "4CAF50"}},
            alignment: {horizontal: "center"},
            border: {
                top: {style: "thin", color: {auto: 1}},
                bottom: {style: "thin", color: {auto: 1}},
                left: {style: "thin", color: {auto: 1}},
                right: {style: "thin", color: {auto: 1}}
            }
        };
    }

    // Tambahkan worksheet ke workbook
    XLSX.utils.book_append_sheet(wb, ws, `Laporan ${monthName}`);
    
    // Simpan file
    XLSX.writeFile(wb, `${title} - ${monthName} ${year}.xlsx`);
}

        
        // Fungsi untuk export laporan tahunan ke PDF
        function exportAnnualPDF() {
            const doc = new jsPDF();
            
            
            const appTitle = getAppTitle();
            const year = document.getElementById('filterYearAnnual').value;
            // Judul laporan
    doc.setFontSize(16);
    doc.setTextColor(46, 125, 50);
    doc.text(`${appTitle.toUpperCase()} - TAHUN ${year}`, doc.internal.pageSize.width / 2, 15, { align: 'center' });
            
            // Tanggal cetak
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const today = new Date();
            doc.text(`Dicetak pada: ${today.toLocaleDateString('id-ID')} ${today.toLocaleTimeString('id-ID')}`, 105, 28, { align: 'center' });
            
            // Ringkasan keuangan
            doc.setFontSize(14);
            doc.setTextColor(33, 37, 41);
            doc.text('Ringkasan Keuangan', 14, 40);
            doc.setDrawColor(76, 175, 80);
            doc.setLineWidth(0.5);
            doc.line(14, 42, 60, 42);
            
            // Data ringkasan
            doc.setFontSize(12);
            doc.text(`Total Pemasukan: ${document.getElementById('annualIncome').textContent}`, 14, 50);
            doc.text(`Total Pengeluaran: ${document.getElementById('annualExpense').textContent}`, 14, 58);
            doc.text(`Saldo: ${document.getElementById('annualBalance').textContent}`, 14, 66);
            
            // Ringkasan bulanan
            doc.setFontSize(14);
            doc.text('Ringkasan Bulanan', 14, 80);
            doc.line(14, 82, 60, 82);
            
            // Buat tabel ringkasan bulanan
            const summaryHeaders = [['Bulan', 'Pemasukan', 'Pengeluaran', 'Saldo']];
            const summaryData = [];
            
            const summaryRows = document.querySelectorAll('#annualMonthlySummaryTable tbody tr');
            summaryRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                summaryData.push([
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent
                ]);
            });
            
            // Tambahkan tabel ke PDF
            doc.autoTable({
                startY: 85,
                head: summaryHeaders,
                body: summaryData,
                headStyles: {
                    fillColor: [76, 175, 80],
                    textColor: [255, 255, 255],
                    fontSize: 10
                },
                bodyStyles: {
                    fontSize: 9
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                styles: {
                    cellPadding: 3,
                    overflow: 'linebreak',
                    halign: 'left'
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 30 }
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, { align: 'center' });
            }
            
            // Simpan PDF
            doc.save(`Laporan Tahunan ${year}.pdf`);
        }
        
        // Fungsi untuk export laporan tahunan ke Excel
       // Fungsi untuk export laporan tahunan ke Excel (diperbarui)
// Fungsi untuk export laporan tahunan ke Excel dengan border
function exportAnnualExcel() {
    const year = document.getElementById('filterYearAnnual').value;
    const title = getAppTitle();
    const today = new Date();
    
    // Siapkan data untuk workbook
    const wb = XLSX.utils.book_new();
    
    // Data dengan format lengkap
    const reportData = [
        [`${title.toUpperCase()} - TAHUN ${year}`],
        ['Dicetak pada: ' + today.toLocaleDateString('id-ID') + ' ' + today.toLocaleTimeString('id-ID')],
        [''],
        ['Ringkasan Keuangan'],
        ['Total Pemasukan', document.getElementById('annualIncome').textContent],
        ['Total Pengeluaran', document.getElementById('annualExpense').textContent],
        ['Saldo', document.getElementById('annualBalance').textContent],
        [''],
        ['Ringkasan Bulanan'],
        ['No.', 'Bulan', 'Pemasukan', 'Pengeluaran', 'Saldo'] // Tambahkan nomor urut
    ];
    
    // Tambahkan data ringkasan bulanan dengan nomor urut
    const summaryRows = document.querySelectorAll('#annualMonthlySummaryTable tbody tr');
    let rowNumber = 1;
    summaryRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        reportData.push([
            rowNumber++,
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].textContent
        ]);
    });
    
    // Buat worksheet
    const ws = XLSX.utils.aoa_to_sheet(reportData);
    
    // Atur lebar kolom
    ws['!cols'] = [
        {wch: 5},  // No.
        {wch: 20}, // Bulan
        {wch: 15}, // Pemasukan
        {wch: 15}, // Pengeluaran
        {wch: 15}  // Saldo
    ];

    // Gabungkan sel untuk judul dan header
    ws['!merges'] = [
        XLSX.utils.decode_range("A1:E1"),
        XLSX.utils.decode_range("A2:E2"),
        XLSX.utils.decode_range("A4:E4"),
        XLSX.utils.decode_range("A8:E8")
    ];

    // Tambahkan border ke seluruh tabel ringkasan bulanan
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 8; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = {c:C, r:R};
            const cell_ref = XLSX.utils.encode_cell(cell_address);
            
            if (!ws[cell_ref]) continue;
            
            ws[cell_ref].s = {
                border: {
                    top: {style: "thin", color: {auto: 1}},
                    bottom: {style: "thin", color: {auto: 1}},
                    left: {style: "thin", color: {auto: 1}},
                    right: {style: "thin", color: {auto: 1}}
                }
            };
        }
    }

    // Style untuk header tabel ringkasan
    for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell_address = {c:C, r:8};
        const cell_ref = XLSX.utils.encode_cell(cell_address);
        
        if (!ws[cell_ref]) continue;
        
        ws[cell_ref].s = {
            font: {bold: true, color: {rgb: "FFFFFF"}},
            fill: {fgColor: {rgb: "4CAF50"}},
            alignment: {horizontal: "center"},
            border: {
                top: {style: "thin", color: {auto: 1}},
                bottom: {style: "thin", color: {auto: 1}},
                left: {style: "thin", color: {auto: 1}},
                right: {style: "thin", color: {auto: 1}}
            }
        };
    }

    // Tambahkan worksheet ke workbook
    XLSX.utils.book_append_sheet(wb, ws, `Laporan ${year}`);
    
    // Simpan file
    XLSX.writeFile(wb, `${title} - Tahun ${year}.xlsx`);
}
        
        // Event listener untuk menutup modal ketika klik di luar modal
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('transactionModal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Event listener untuk currency formatting
        document.querySelectorAll('.currency').forEach(element => {
            const value = parseFloat(element.textContent.replace(/[^0-9.-]+/g,"")) || 0;
            element.textContent = formatCurrency(value);
        });

        // Fungsi untuk mengkonversi chart ke gambar base64
async function chartToBase64(chartId) {
    const chartCanvas = document.getElementById(chartId);
    if (!chartCanvas) return null;
    
    // Clone canvas untuk menghindari masalah ukuran
    const clonedCanvas = document.createElement('canvas');
    const originalCanvas = chartCanvas;
    
    // Set ukuran yang sesuai
    clonedCanvas.width = originalCanvas.width;
    clonedCanvas.height = originalCanvas.height;
    
    const ctx = clonedCanvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, clonedCanvas.width, clonedCanvas.height);
    ctx.drawImage(originalCanvas, 0, 0);
    
    return clonedCanvas.toDataURL('image/png');
}

// Inisialisasi tahun untuk filter
function initYearFilter() {
            const yearSelect = document.getElementById('filterYear');
            const currentYear = new Date().getFullYear();
            
            yearSelect.innerHTML = '';
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

// Fungsi untuk mengubah tampilan filter berdasarkan jenis yang dipilih
function changeFilterType() {
    const filterType = document.getElementById('filterType').value;
    
    // Sembunyikan semua kontrol filter
    document.querySelectorAll('.filter-control').forEach(control => {
        control.style.display = 'none';
    });
    
    // Tampilkan kontrol yang sesuai
    if (filterType === 'date') {
        document.getElementById('dateFilterControl').style.display = 'block';
        // Set tanggal default ke hari ini
        document.getElementById('filterDate').valueAsDate = new Date();
    } else if (filterType === 'month') {
        document.getElementById('monthFilterControl').style.display = 'block';
        // Set bulan dan tahun default
        const today = new Date();
        document.getElementById('filterMonth').value = (today.getMonth() + 1).toString().padStart(2, '0');
        fillYearDropdowns(); // Panggil fungsi untuk mengisi tahun
    } else if (filterType === 'range') {
        document.getElementById('rangeFilterControl').style.display = 'block';
        // Set rentang default 1 bulan terakhir
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(endDate.getMonth() - 1);
        
        document.getElementById('filterStartDate').valueAsDate = startDate;
        document.getElementById('filterEndDate').valueAsDate = endDate;
    }
    
    // Terapkan filter
    filterTransactions();
}
// Fungsi utama untuk memfilter transaksi

function filterTransactions() {
    const filterType = document.getElementById('filterType').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    let filteredTransactions = [...transactions];
    
    // Filter berdasarkan jenis filter
    if (filterType === 'date') {
        const selectedDate = document.getElementById('filterDate').value;
        if (selectedDate) {
            filteredTransactions = filteredTransactions.filter(t => t.tanggal === selectedDate);
        }
    } else if (filterType === 'month') {
        const month = document.getElementById('filterMonth').value;
        const year = document.getElementById('filterYear').value;
        
        if (month && year) {
            filteredTransactions = filteredTransactions.filter(t => {
                const [tYear, tMonth] = t.tanggal.split('-');
                return tYear === year && tMonth === month;
            });
        }
    } else if (filterType === 'range') {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        if (startDate && endDate) {
            filteredTransactions = filteredTransactions.filter(t => {
                return t.tanggal >= startDate && t.tanggal <= endDate;
            });
        }
    }
    
    // Filter berdasarkan pencarian teks
    if (searchTerm) {
        filteredTransactions = filteredTransactions.filter(t => {
            return (
                t.keterangan.toLowerCase().includes(searchTerm) ||
                t.jumlah.toString().includes(searchTerm) ||
                t.tanggal.includes(searchTerm) ||
                (t.tipe === 'pemasukan' ? 'pemasukan' : 'pengeluaran').includes(searchTerm)
            );
        });
    }
    
    // Update tabel dengan transaksi yang sudah difilter
    updateTransactionTable(filteredTransactions);
    
    // Hitung total berdasarkan filter
    calculateFilteredTotals(filteredTransactions);
}

// Panggil fungsi inisialisasi saat halaman dimuat
window.addEventListener('DOMContentLoaded', () => {
    initYearFilter();
    changeFilterType(); // Set filter default
});

function getAppTitle() {
    const savedTitle = localStorage.getItem('appTitle');
    return savedTitle || 'LAPORAN KEUANGAN HARIAN'; // Default title jika belum diatur
}

function initReportYearFilter() {
    const yearSelect = document.getElementById('reportMonthYear');
    const currentYear = new Date().getFullYear();
    
    yearSelect.innerHTML = '';
    for (let year = currentYear - 5; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

// Fungsi untuk inisialisasi filter tahun laporan tahunan (hingga 2030)
function initAnnualYearFilter() {
    const yearSelect = document.getElementById('filterYearAnnual');
    const currentYear = new Date().getFullYear();
    
    yearSelect.innerHTML = '';
    for (let year = currentYear - 5; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

        function calculateFilteredTotals(filteredTransactions) {
    let totalPemasukan = 0;
    let totalPengeluaran = 0;
    
    filteredTransactions.forEach(transaction => {
        if (transaction.tipe === 'pemasukan') {
            totalPemasukan += transaction.jumlah;
        } else {
            totalPengeluaran += transaction.jumlah;
        }
    });
    
    const saldoAkhir = totalPemasukan - totalPengeluaran;
    
    // Update tampilan dashboard
    document.getElementById('totalPemasukan').textContent = formatCurrency(totalPemasukan);
    document.getElementById('totalPengeluaran').textContent = formatCurrency(totalPengeluaran);
    document.getElementById('saldoAkhir').textContent = formatCurrency(saldoAkhir);
}
    </script>
</body>
</html>